<div class="row">
  <app-filter class="col-3" (filterChanged)="onFilterChange($event)" [filterByName]="'events'"></app-filter>
  <app-pagination class="col-6 text-center" [totalItems]="filteredEvents.length" [itemsPerPage]="itemsPerPage"
    [currentPage]="currentPage" (pageChange)="onPageChange($event)"></app-pagination>
  <div class="col-3 text-end">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitEventModal"
      (click)="fetchNewEvent()">
      Create New Event
    </button>
  </div>
</div>

<div class="row mt-4" *ngIf="paginatedEvents.length; else noEvents">
  @for(event of paginatedEvents; track event.id){
  <div class="col-md-6 mb-5">
    <div class="event-container text-center">
      <img [src]="event.image" class="img-fluid" alt="">
      <div class="mt-2">
        <div class="align-items-center mb-2 d-flex justify-content-center mt-2" style="height: 50px;">
          <h4><strong>{{ event.name }} </strong></h4>
        </div>
        <div class="row mt-2">
          <div class="col-6">
            <strong>{{ event.date | date: 'MMM dd' }}</strong>
            <p>{{ event.startTime }} - {{event.endTime}}</p>
          </div>
          <div class="col-6 d-flex align-items-center justify-content-center">

            <p>{{event.users.accepted.length}} / {{ event.limit }}</p>
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#submitEventModal"
              (click)="fetchEditEvent(event.id)">Edit</button>
          </div>
          <div class="col-6">
            <button data-bs-toggle="modal" data-bs-target="#viewEventModal" class="btn btn-primary"
              (click)="setSelectedEvent(event.id)">
              View
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>
<ng-template #noEvents>
  <div class="mt-3">
    <p>No Events available.</p>
  </div>
</ng-template>




<div class="modal fade" id="viewEventModal" tabindex="-1" aria-labelledby="viewEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewEventModalLabel">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <h2><b>{{ selectedEvent.name }}</b></h2>
        </div>
        <div class="row mt-2">
          <div class="col-6">
            <strong d-flex justify-content-center>Date:</strong> {{ selectedEvent.date | date: 'MMM dd' }} <br>
            <strong>Time:</strong> {{ selectedEvent.startTime }} - {{ selectedEvent.endTime }}
          </div>
          <div class="col-6 d-flex align-items-center justify-content-center">
            <p style="margin:auto">{{ selectedEvent.location }}</p>
          </div>
        </div>
        <hr>
        <p>{{ selectedEvent.description }}</p>
        <ul class="list-group info mt-3">
          <ng-container *ngFor="let status of userStatuses">
            <button [ngClass]="{
                'disabled': selectedEvent.users[status].length === 0,
                'dropdown-button btn btn-primary list-group-item mt-2 d-flex justify-content-between': true
              }" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#users' + status | titlecase"
              aria-expanded="false" [attr.aria-controls]="'users' + status | titlecase">
              <strong>{{ status | titlecase }}</strong>
              <span class="badge" [ngClass]="{
                  'text-bg-secondary': selectedEvent.users[status].length === 0,
                  'text-bg-primary': selectedEvent.users[status].length > 0
                }">
                {{ selectedEvent.users[status].length }}
              </span>
            </button>
            <div *ngIf="selectedEvent.users[status].length > 0" class="collapse"
              [attr.id]="'users' + status | titlecase">
              <ul class="list-group dropdown-list">
                <li *ngFor="let user of selectedEvent.users[status]"
                  class="list-group-item d-flex justify-content-between" [value]="user.id">
                  {{ user.first_name }} {{ user.last_name }}
                </li>
              </ul>
            </div>
          </ng-container>
        </ul>

        <div *ngIf="selectedEvent.subevent_name">
          <hr>
          <hr>
          <div class="text-center">
            <h2><b>{{ selectedEvent.subevent_name }}</b></h2>
          </div>
          <div class="row mt-2">
            <div class="col-6">
              <strong d-flex justify-content-center>Date:</strong> {{ selectedEvent.subevent_date | date: 'MMM dd' }}
              <br>
              <strong>Time:</strong> {{ selectedEvent.subevent_startTime }} - {{ selectedEvent.subevent_endTime }}
            </div>
            <div class="col-6 d-flex align-items-center justify-content-center">
              <p style="margin:auto">{{ selectedEvent.subevent_location }}</p>
            </div>
          </div>
          <hr>
          <p>{{ selectedEvent.subevent_description }}</p>
          <ul class="list-group info mt-3">
            <ng-container *ngFor="let status of userStatuses">
              <button [ngClass]="{
                  'disabled': selectedEvent.subevent_users[status].length === 0,
                  'dropdown-button btn btn-primary list-group-item mt-2 d-flex justify-content-between': true
                }" type="button" data-bs-toggle="collapse" [attr.data-bs-target]="'#subevent_users' + status | titlecase"
                aria-expanded="false" [attr.aria-controls]="'subevent_users' + status | titlecase">
                <strong>{{ status | titlecase }}</strong>
                <span class="badge" [ngClass]="{
                    'text-bg-secondary': selectedEvent.subevent_users[status].length === 0,
                    'text-bg-primary': selectedEvent.subevent_users[status].length > 0
                  }">
                  {{ selectedEvent.subevent_users[status].length }}
                </span>
              </button>
              <div *ngIf="selectedEvent.subevent_users[status].length > 0" class="collapse"
                [attr.id]="'subevent_users' + status | titlecase">
                <ul class="list-group dropdown-list">
                  <li *ngFor="let user of selectedEvent.subevent_users[status]"
                    class="list-group-item d-flex justify-content-between" [value]="user.id">
                    {{ user.first_name }} {{ user.last_name }}
                  </li>
                </ul>
              </div>
            </ng-container>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="submitEventModal" tabindex="-1" aria-labelledby="submitEventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="submitEventModalLabel">{{ newEventSubmit ? 'Create New Event' : 'Edit Event' }}
        </h5>
        <button type="button" id="closeModalButton" class="btn-close" data-bs-dismiss="modal"
          aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="eventForm" (ngSubmit)="submitEvent()">
          <div class="mb-2 row">
            <div class="col-9">
              <div class="form-floating mb-3">
                <input type="text" id="eventName" formControlName="name" class="form-control form-control-sm"
                  placeholder="Enter event name" required>
                <label for="eventName" class="form-label">Event Name</label>
              </div>
            </div>
            <div class="col-3">
              <div class="form-floating">
                <input type="text" id="eventLimit" formControlName="limit" class="form-control" placeholder="15"
                  min="1">
                <label class="form-label" for="eventLimit">Limit</label>
              </div>
            </div>
          </div>
          <div class="mb-3 row">
            <div class="col-3 d-flex align-items-center">
              <div class="form-floating">
                <input type="file" id="eventImage" accept="image/*" class="form-control" placeholder="upload image"
                  (change)="onImageSelected($event)">
                <label for="eventImage" class="form-label">Image</label>
              </div>
            </div>
            <div class="col-3 d-flex align-items-center justify-content-center">
              <img [src]="imagePreviewSrc" alt="" style="height: 50px;">
            </div>
            <div class="col-6 d-flex align-items-center">
              <ng-multiselect-dropdown class="w-100 form-control" formControlName="teams"
                [placeholder]="'Eligible Teams'" [settings]="dropdownSettings" [data]="teamsInDropdownFormat">
              </ng-multiselect-dropdown>
            </div>
          </div>
          <div class="mb-3 row">
            <div class="col-6">
              <div class="form-floating">
                <input type="date" id="eventDate" formControlName="date" class="form-control"
                  placeholder="Enter event date">
                <label for="eventDate" class="form-label">Event Date</label>
              </div>
            </div>
            <div class="col-3">
              <div class="form-floating">
                <input type="time" id="startTime" formControlName="startTime" class="form-control"
                  placeholder="Enter start time">
                <label for="startTime" class="form-label">Start Time</label>
              </div>
            </div>
            <div class="col-3">
              <div class="form-floating">
                <input type="time" id="endTime" formControlName="endTime" class="form-control"
                  placeholder="Enter end time">
                <label for="endTime" class="form-label">End Time</label>
              </div>
            </div>
          </div>
          <div class="mb-3 form-floating">
            <input type="text" id="eventLocation" formControlName="location" class="form-control"
              placeholder="Enter event location">
            <label for="eventLocation" class="form-label">Location</label>
          </div>
          <div class="mb-3 form-floating">
            <textarea id="eventDescription" formControlName="description" class="form-control"
              placeholder="Enter event description" rows="3"></textarea>
            <label for="eventDescription" class="form-label">Description</label>
          </div>


          <div class="collapse mt-3" id="subEventCreation">
            <div class="mb-2 row">
              <hr>
              <hr>
              <div class="col-12">
                <div class="form-floating mb-3">
                  <input type="text" id="subevent_name" formControlName="subevent_name"
                    class="form-control form-control-sm" placeholder="Enter sub event name" required>
                  <label for="subevent_name" class="form-label">Sub Event Name</label>
                </div>
              </div>
            </div>
            <div class="mb-3 row">
              <div class="col-4">
                <div class="form-floating">
                  <input type="text" id="subevent_limit" formControlName="subevent_limit" class="form-control"
                    placeholder="15" min="1">
                  <label class="form-label" for="subevent_eventLimit">Limit</label>
                </div>
              </div>
              <div class="col-4">
                <div class="form-floating">
                  <input type="time" id="subevent_startTime" formControlName="subevent_startTime" class="form-control"
                    placeholder="Enter start time">
                  <label for="subevent_startTime" class="form-label">Start Time</label>
                </div>
              </div>
              <div class="col-4">
                <div class="form-floating">
                  <input type="time" id="subevent_endTime" formControlName="subevent_endTime" class="form-control"
                    placeholder="Enter end time">
                  <label for="subevent_endTime" class="form-label">End Time</label>
                </div>
              </div>
            </div>
            <div class="mb-3 form-floating">
              <input type="text" id="subevent_location" formControlName="subevent_location" class="form-control"
                placeholder="Enter event location">
              <label for="subevent_location" class="form-label">Location</label>
            </div>

            <div class="mb-3 form-floating">
              <textarea id="subevent_description" formControlName="subevent_description" class="form-control"
                placeholder="Enter event description" rows="3"></textarea>
              <label for="subevent_description" class="form-label">Description</label>
            </div>
            <div class="mb-3 d-flex justify-content-center"
              [ngClass]="{ 'show': hasSubEvent(), 'hide': !hasSubEvent() }">
              <button type="button" class="btn btn-danger btn-sm" (click)="deleteSubEvent()">Delete Sub Event</button>
            </div>
          </div>
          <div *ngFor="let error of errors">
            <p class="text-danger text-center"> {{ error }}! </p>
          </div>

          <div class="d-flex justify-content-between">
            <button class="btn btn-secondary" *ngIf="!subEventCollapse" type="button" data-bs-toggle="collapse"
              data-bs-target="#subEventCreation" aria-expanded="false" aria-controls="subEventCreation"
              id="subEventCreationButton"
              (click)="subEventCollapse = !subEventCollapse">@if(eventForm.get('subevent_name')?.value){Show Sub
              Event}@else{Create
              Sub Event} <i class="bi bi-arrow-down-short"></i>
            </button>
            <button class="btn btn-secondary" *ngIf="subEventCollapse" type="button" data-bs-toggle="collapse"
              data-bs-target="#subEventCreation" aria-expanded="false" aria-controls="subEventCreation"
              id="subEventCreationButton" (click)="subEventCollapse = !subEventCollapse">
              Hide Sub Event <i class="bi bi-arrow-up-short"></i>
            </button>
            <button type="button" *ngIf="!newEventSubmit" class="btn btn-danger" (click)="deleteEvent()"
              data-bs-toggle="modal" data-bs-target="#confirmationModal">Delete Event</button>
            <button type="submit" class="btn btn-primary">
              {{ newEventSubmit ? 'Create New Event' : 'Save Event'}}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Are you sure you want to {{confirmationMessage}}?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmAction" data-bs-dismiss="modal"
          (click)="actionAfterConfirmation()">Confirm</button>
      </div>
    </div>
  </div>
</div>